name: Generate Playlist

on:
  schedule:
    - cron: "0 */7 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create generator
        run: |
          echo '<?php' > generator.php

          echo '$api="https://livetv-hub.cricindia95.workers.dev/channel.json";' >> generator.php
          echo '$cookie_api="https://cookie.cricindia95.workers.dev";' >> generator.php

          echo '$json=@json_decode(@file_get_contents($api),true);' >> generator.php
          echo 'if(!is_array($json)){echo "#EXTM3U\n# Error";exit;}' >> generator.php

          echo '$cookie=trim(@file_get_contents($cookie_api));' >> generator.php
          echo 'if(!$cookie)$cookie="";' >> generator.php

          # CLEAN cookie only for URL, NOT for header
          echo '$clean=str_replace("__hdnea__=","",$cookie);' >> generator.php

          echo 'echo "#EXTM3U"\n;' >> generator.php
          echo 'echo "#DATE: ".date("l d F, Y H:i:s")."\n\n";' >> generator.php

          echo 'foreach($json as $c){' >> generator.php
          echo '$id=$c["tvg-id"]??"";' >> generator.php
          echo '$grp=$c["group-title"]??"Others";' >> generator.php
          echo '$logo=$c["tvg-logo"]??"";' >> generator.php
          echo '$name=$c["channel-name"]??"Unknown";' >> generator.php
          echo '$key=$c["license_key"]??"";' >> generator.php
          echo '$url=$c["mpd_url"]??"";' >> generator.php

          echo 'echo "#EXTINF:-1 tvg-id=\"$id\" group-title=\"$grp\" tvg-logo=\"$logo\",$name\n";' >> generator.php
          echo 'echo "#EXTVLCOPT:http-user-agent=plaYtv/7.1.3 (Linux;Android 13)\n";' >> generator.php

          # Jio URLs need cookie + DRM
          echo 'if(strpos($url,"jiotvpllive")!==false || strpos($url,"bpk-tv")!==false){' >> generator.php

          echo 'if(!empty($key)){' >> generator.php
          echo 'echo "#KODIPROP:inputstream.adaptive.license_type=clearkey\n";' >> generator.php
          echo 'echo "#KODIPROP:inputstream.adaptive.license_key=$key\n";' >> generator.php
          echo '}' >> generator.php

          # EXTHTTP uses raw cookie
          echo 'echo "#EXTHTTP:{\"cookie\":\"$cookie\"}\n";' >> generator.php

          # Final URL (PERFECT FORMAT)
          echo '$final = $url . "?__hdnea__=" . $clean . "&xxx=%7Ccookie=" . $cookie;' >> generator.php

          echo 'echo $final."\n\n";' >> generator.php
          echo 'continue;' >> generator.php
          echo '}' >> generator.php

          echo 'echo $url."\n\n";' >> generator.php
          echo '}' >> generator.php

      - name: Run generator
        run: php generator.php > playlist.m3u

      - name: Commit playlist
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add playlist.m3u
          git commit -m "Auto update" || echo "No changes"
          git push
