name: Generate Playlist

on:
  schedule:
    - cron: "0 */7 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Write PHP generator
        run: |
          echo '<?php' > generator.php
          echo 'header("Content-Type: audio/x-mpegurl; charset=UTF-8");' >> generator.php
          echo 'header("Content-Disposition: inline; filename=playlist.m3u");' >> generator.php

          echo '$api = "https://livetv-hub.cricindia95.workers.dev/channel.json";' >> generator.php
          echo '$cookie_api = "https://cookie.cricindia95.workers.dev";' >> generator.php

          echo '$data = @file_get_contents($api);' >> generator.php
          echo 'if(!$data){ echo "#EXTM3U\n# Error fetching API\n"; exit; }' >> generator.php

          echo '$json = json_decode($data, true);' >> generator.php
          echo 'if(!is_array($json)){ echo "#EXTM3U\n# Error invalid JSON\n"; exit; }' >> generator.php

          echo '$cookie = trim(@file_get_contents($cookie_api));' >> generator.php
          echo 'if(!$cookie){ $cookie=""; }' >> generator.php

          echo 'echo "#EXTM3U x-tvg-url=\"https://avkb.short.gy/jioepg.xml.gz\"\n";' >> generator.php
          echo 'echo "#DATE: ".date("l d F, Y H:i:s")."\n\n";' >> generator.php

          echo 'foreach($json as $c){' >> generator.php
          echo '$tvg = $c["tvg-id"] ?? "";' >> generator.php
          echo '$grp = $c["group-title"] ?? "Others";' >> generator.php
          echo '$logo = $c["tvg-logo"] ?? "";' >> generator.php
          echo '$name = $c["channel-name"] ?? "Unknown";' >> generator.php
          echo '$key = $c["license_key"] ?? "";' >> generator.php
          echo '$mpd = $c["mpd_url"] ?? "";' >> generator.php

          echo 'if(!empty($key)){' >> generator.php
          echo 'echo "#KODIPROP:inputstream.adaptive.license_type=clearkey\n";' >> generator.php
          echo 'echo "#KODIPROP:inputstream.adaptive.license_key={$key}\n";' >> generator.php
          echo '}' >> generator.php

          echo 'echo "#EXTHTTP:{\"cookie\":\"$cookie\"}\n";' >> generator.php

          echo '$ec = urlencode("|cookie=$cookie");' >> generator.php
          echo '$final = $mpd."?__hdnea__=$cookie&xxx=".$ec;' >> generator.php

          echo 'echo "#EXTINF:-1 tvg-id=\"$tvg\" tvg-logo=\"$logo\" group-title=\"$grp\",$name\n";' >> generator.php
          echo 'echo "$final\n\n";' >> generator.php
          echo '}' >> generator.php

      - name: Run generator
        run: php generator.php > playlist.m3u

      - name: Commit playlist.m3u
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add playlist.m3u
          git commit -m "Auto update" || echo "No changes"
          git push
